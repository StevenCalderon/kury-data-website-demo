---
// ContactForm.astro
import styles from "./ContactForm.module.css";
---

<section class={styles.section} id="contact-form">
  <div class={styles.container}>
    <!-- Illustration on the left side -->
    <div class={styles.leftColumn}>
      <img
        src="/images/ilustracion.png"
        alt="Ilustración de contacto"
        class={styles.illustration}
      />
    </div>

    <!-- Form column -->
    <div class={styles.formColumn}>
      <!-- Header -->
      <div class={styles.heading}>
        <h2 class={styles.title}>
          Hablemos de tu próximo<br />gran proyecto
        </h2>
        <p class={styles.description}>
          Cuéntanos qué tienes en mente y nuestro equipo técnico se pondrá en
          contacto contigo para definir la hoja de ruta.
        </p>
      </div>

      <!-- Contact form -->
      <form class={styles.form} id="contactForm">
        <!-- Field: Name -->
        <div class={styles.formGroup}>
          <label for="name" class={styles.label}>Nombre</label>
          <input
            type="text"
            id="name"
            name="name"
            placeholder="Ej: Juan Pérez"
            class={styles.input}
            required
          />
        </div>

        <!-- Row: Company and Budget -->
        <div class={styles.formRow}>
          <div class={styles.formGroup}>
            <label for="company" class={styles.label}>
              Nombre de tu Empresa / Startup
            </label>
            <input
              type="text"
              id="company"
              name="company"
              placeholder="Ej: TechSolutions Inc."
              class={styles.input}
              required
            />
          </div>

          <div class={styles.formGroup}>
            <label for="budget" class={styles.label}>
              Presupuesto estimado (USD)
            </label>
            <select id="budget" name="budget" class={styles.select}>
              <option value="" disabled selected hidden>1000 - 5000</option>
              <option value="">Desmarcar valor</option>
              <option value="1000-5000">1000 - 5000</option>
              <option value="5000-10000">5000 - 10000</option>
              <option value="10000-25000">10000 - 25000</option>
              <option value="25000-50000">25000 - 50000</option>
              <option value="50000+">50000+</option>
            </select>
          </div>
        </div>

        <!-- Field: Message -->
        <div class={styles.formGroup}>
          <label for="message" class={styles.label}>
            Cuéntanos brevemente sobre el proyecto
          </label>
          <textarea
            id="message"
            name="message"
            rows="5"
            placeholder="Necesito una API para integrar pagos..."
            class={styles.textarea}
            required></textarea>

          <!-- Validation message (always visible, reserves space) -->
          <p class={styles.validationMessage} id="statusMessage">
            Debes elegir un nombre
          </p>
        </div>

        <!-- Submit button -->
        <button type="submit" class={styles.submitButton} id="submitBtn">
          Enviar Mensaje
        </button>
      </form>
    </div>
  </div>
</section>

<!-- Script to load EmailJS from CDN -->
<script is:inline>
  (function () {
    const script = document.createElement("script");
    script.src =
      "https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js";
    script.async = true;

    script.onload = function () {
      if (window.emailjs) {
        window.emailjs.init("B1YGgutsB6xdLddFx");
      }
    };

    document.head.appendChild(script);
  })();
</script>

<script>
  // EmailJS configuration
  const EMAILJS_SERVICE_ID = "service_cyeb7hi";
  const EMAILJS_TEMPLATE_ID = "template_acuixsp";

  // DOM elements
  const form = document.getElementById("contactForm") as HTMLFormElement;
  const budgetSelect = document.getElementById("budget") as HTMLSelectElement;
  const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
  const statusMessage = document.getElementById(
    "statusMessage",
  ) as HTMLParagraphElement;

  // Function to remove browser autofill background
  function removeAutofillStyles() {
    const inputs = document.querySelectorAll("input, textarea");
    inputs.forEach((input) => {
      const element = input as HTMLElement;
      element.style.backgroundColor = "transparent";
      element.style.backgroundImage = "none";
      element.style.transition = "none";

      // Restore transition after applying styles
      setTimeout(() => {
        element.style.transition = "all 0.3s ease";
      }, 10);
    });
  }

  // Execute on page load and when user interacts with fields
  document.addEventListener("DOMContentLoaded", removeAutofillStyles);
  setTimeout(removeAutofillStyles, 100);
  setTimeout(removeAutofillStyles, 500);

  const allInputs = document.querySelectorAll("input, textarea");
  allInputs.forEach((input) => {
    input.addEventListener("focus", removeAutofillStyles);
    input.addEventListener("blur", removeAutofillStyles);
  });

  // Change select color when user chooses an option
  budgetSelect?.addEventListener("change", () => {
    if (budgetSelect.value === "") {
      budgetSelect.selectedIndex = 0;
      budgetSelect.style.color = "var(--color-gray-500)";
    } else {
      budgetSelect.style.color = "var(--color-white)";
    }
  });

  // Wait for EmailJS to be available
  function waitForEmailJS(maxAttempts = 20): Promise<any> {
    return new Promise((resolve, reject) => {
      let attempts = 0;

      const checkEmailJS = setInterval(() => {
        attempts++;

        if ((window as any).emailjs) {
          clearInterval(checkEmailJS);
          resolve((window as any).emailjs);
        } else if (attempts >= maxAttempts) {
          clearInterval(checkEmailJS);
          reject(
            new Error(
              "EmailJS did not load after " + maxAttempts + " attempts",
            ),
          );
        }
      }, 200);
    });
  }

  // Function to send email using EmailJS
  async function sendEmail(formData: FormData) {
    // Prepare form data for EmailJS template
    const templateParams = {
      from_name: formData.get("name"),
      from_company: formData.get("company"),
      budget: formData.get("budget") || "Not specified",
      message: formData.get("message"),
      timestamp: new Date().toLocaleString("es-ES"),
    };

    try {
      // Wait for EmailJS to be available
      const emailjs = await waitForEmailJS();

      // Send email
      const response = await emailjs.send(
        EMAILJS_SERVICE_ID,
        EMAILJS_TEMPLATE_ID,
        templateParams,
      );

      return { success: true, response };
    } catch (error: any) {
      let errorMessage = "Unknown error";
      if (error.text) errorMessage = error.text;

      return { success: false, error, errorMessage };
    }
  }

  // Handle form submission
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Disable button to prevent multiple submissions
    submitBtn.disabled = true;
    submitBtn.textContent = "Enviando...";

    // Clear message and show sending status
    statusMessage.textContent = "";
    statusMessage.style.color = "#596387";

    // Get form data
    const formData = new FormData(form);

    // Send email
    const result = await sendEmail(formData);

    if (result.success) {
      // Show success message
      statusMessage.textContent = "✓ Mensaje enviado correctamente";
      statusMessage.style.color = "#10b981";

      // Clear form
      form.reset();

      // Reset budget select
      if (budgetSelect) {
        budgetSelect.selectedIndex = 0;
        budgetSelect.style.color = "var(--color-gray-500)";
      }

      // Clear autofill styles
      setTimeout(removeAutofillStyles, 50);

      // Return to initial message after 5 seconds
      setTimeout(() => {
        statusMessage.textContent = "Debes elegir un nombre";
        statusMessage.style.color = "#596387";
      }, 5000);
    } else {
      // Show error message
      statusMessage.textContent = "✗ Error al enviar. Intenta nuevamente";
      statusMessage.style.color = "#ef4444";

      // Return to initial message after 5 seconds
      setTimeout(() => {
        statusMessage.textContent = "Debes elegir un nombre";
        statusMessage.style.color = "#596387";
      }, 5000);
    }

    // Re-enable button
    submitBtn.disabled = false;
    submitBtn.textContent = "Enviar Mensaje";
  });
</script>

<style>
  /* Style for disabled button */
  #submitBtn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>