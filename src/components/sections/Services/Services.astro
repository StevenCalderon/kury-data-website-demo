---
import styles from './Services.module.css';

const services = [
    {
        id: 1,
        name: "Diseño UX / UI Premium",
        description: "Diseñamos interfaces intuitivas mediante una investigación rigurosa de usabilidad para maximizar las tasas de conversión y la participación del usuario en todas tus plataformas digitales.",
        image: "/images/UI-carousel.svg",
    },
    {
        id: 2,
        name: "Inteligencia Artificial Aplicada",
        description: "Integramos modelos avanzados de Machine Learning para automatizar flujos de trabajo, transformando datos en bruto en información predictiva para una toma de decisiones operativas más inteligente.",
        image: "/images/AI-carousel.svg",
    },
    {
        id: 3,
        name: "Arquitectura Cloud y DevOps",
        description: "Diseñamos infraestructuras en la nube escalables y de alta disponibilidad, garantizando la integridad de los datos y la implementación continua bajo cargas empresariales exigentes.",
        image: "/images/devOps-carousel.svg",
    },
    {
        id: 4,
        name: "Soluciones Blockchain y Web3",
        description: "Desarrollamos contratos inteligentes y aplicaciones descentralizadas seguras, aprovechando la tecnología de registros distribuidos para ofrecer seguridad criptográfica en las transacciones.",
        image: "/images/Blockchain-carousel.svg",
    },
    {
        id: 5,
        name: "Big Data y Analítica",
        description: "Construimos pipelines de datos de alto rendimiento para procesar grandes volúmenes de información, proporcionando herramientas avanzadas de visualización para extraer insights estratégicos de negocio.",
        image: "/images/Data-carousel.svg"
    },
    {
        id: 6,
        name: "Ecosistemas de APIs a Medida",
        description: "Diseñamos APIs RESTful y GraphQL robustas para un intercambio de datos seguro, sincronizando eficientemente tu arquitectura de software con plataformas de terceros.",
        image: "/images/API-carousel.svg",
    }
];

---

<section id={styles.presentationServices} class={styles.section}>
  <div class={styles.worldImage}>
  </div>
  <div class={styles.titleContainer}>
    <h2 class={styles.title}>Diseñamos la Próxima Generación de Software</h2>
    <p class={styles.descriptionServices}>
      Conectamos los desafíos empresariales complejos con soluciones digitales escalables, utilizando arquitecturas de vanguardia para construir hoy el futuro de tu empresa.
    </p>
  </div>

  <div class={styles.carouselWrapper}>
    <div class={styles.carouselContainer} id="carousel-container">
      <div class={styles.carouselTrack} id="carousel-track">
        {services.map((service) => (
          <div class={styles.serviceCard}>
            <div class={styles.cardContent}>
              <h3 class={styles.cardTitle}>{service.name}</h3>
              <p class={styles.cardDescription}>{service.description}</p>
            </div>
            <div class={styles.cardImage}>
              <img src={service.image} alt={service.name} />
            </div>
          </div>
        ))}
      </div>
    </div>
    
    <div
      class={styles.carouselPagination}
      id="carousel-pagination"
      aria-live="polite"
      data-dot-class={styles.paginationDot}
    >
    </div>
  </div>
</section>

<script>
  (function initCarousel() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCarousel);
      return;
    }

    const container = document.getElementById('carousel-container');
    const trackNode = document.getElementById('carousel-track');
    const paginationNode = document.getElementById('carousel-pagination');
    if (!container || !trackNode || !paginationNode) return;

    const track = trackNode as HTMLElement;
    const paginationEl = paginationNode as HTMLElement;
    const totalCards = track.children.length;

    // Breakpoints y cantidad detarjetas caben por vista
    function getViewportConfig() {
      const w = window.innerWidth;
      if (w <= 480) return { cardsPerView: 1, gap: 16 };
      if (w <= 768) return { cardsPerView: 2, gap: 24 };
      if (w <= 1024) return { cardsPerView: 3, gap: 24 };
      return { cardsPerView: 4, gap: 24 };
    }

    let currentGroup = 0;
    let config = getViewportConfig();

    function getCardWidth(): number {
      const firstCard = track.children[0] as HTMLElement | undefined;
      return firstCard ? firstCard.offsetWidth : 0;
    }

    function getGroupOffset(groupIndex: number, cardsPerView: number, gapPx: number): number {
      const cardWidth = getCardWidth();
      if (cardWidth === 0) return 0;
      const remaining = totalCards - groupIndex * cardsPerView;
      const startIndex =
        remaining < cardsPerView && groupIndex > 0
          ? totalCards - cardsPerView
          : groupIndex * cardsPerView;
      return startIndex * (cardWidth + gapPx);
    }

    function buildPaginationDots() {
      config = getViewportConfig();
      const totalGroups = Math.ceil(totalCards / config.cardsPerView);
      currentGroup = Math.min(currentGroup, totalGroups - 1);
      if (currentGroup < 0) currentGroup = 0;

      paginationEl.innerHTML = '';
      for (let i = 0; i < totalGroups; i++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = paginationEl.getAttribute('data-dot-class') || 'paginationDot';
        btn.setAttribute('data-group', String(i));
        btn.setAttribute('aria-label', `Ir al grupo ${i + 1} de ${totalGroups}`);
        btn.setAttribute('aria-current', i === currentGroup ? 'true' : 'false');
        btn.addEventListener('click', () => {
          currentGroup = i;
          updateCarousel();
          updateDotsActiveState();
        });
        paginationEl.appendChild(btn);
      }
    }

    function updateDotsActiveState() {
      const dots = paginationEl.querySelectorAll('[data-group]');
      const totalGroups = dots.length;
      dots.forEach((dot, index) => {
        const isActive = index === currentGroup;
        dot.setAttribute('aria-current', isActive ? 'true' : 'false');
        dot.classList.toggle('active', isActive);
      });
    }

    function updateCarousel() {
      const cardWidth = getCardWidth();
      if (cardWidth === 0) {
        setTimeout(updateCarousel, 100);
        return;
      }
      config = getViewportConfig();
      const translateX = getGroupOffset(currentGroup, config.cardsPerView, config.gap);
      track.style.transform = `translateX(-${translateX}px)`;
      track.style.transition = 'transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      updateDotsActiveState();
    }

    const AUTO_ADVANCE_MS_SMALL_VIEW = 3000; // 1–2 cards visible
    const AUTO_ADVANCE_MS_LARGE_VIEW = 5000; // 3–4 cards visible
    let autoAdvanceIntervalId: ReturnType<typeof setInterval> | undefined;

    function startAutoAdvance() {
      if (autoAdvanceIntervalId) clearInterval(autoAdvanceIntervalId);
      config = getViewportConfig();
      const intervalMs =
        config.cardsPerView <= 2 ? AUTO_ADVANCE_MS_SMALL_VIEW : AUTO_ADVANCE_MS_LARGE_VIEW;
      autoAdvanceIntervalId = setInterval(() => {
        config = getViewportConfig();
        const totalGroups = Math.ceil(totalCards / config.cardsPerView);
        if (totalGroups <= 1) return;
        currentGroup = (currentGroup + 1) % totalGroups;
        updateCarousel();
      }, intervalMs);
    }

    buildPaginationDots();
    setTimeout(updateCarousel, 100);
    startAutoAdvance();

    let resizeTimeout: ReturnType<typeof setTimeout> | undefined;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        buildPaginationDots();
        updateCarousel();
        startAutoAdvance();
      }, 250);
    });
  })();
</script>
